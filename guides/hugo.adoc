= Hugo Bookshop
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:toc:
:toc-placement!:

toc::[]

IMPORTANT: Hugo support should be treated as a semi-stable beta

== Quick start
To jump right into using Bookshop on a Hugo site, check out the link:https://github.com/CloudCannon/hugo-bookshop-starter[Hugo Bookshop Starter] 

== Hugo Configuration

To use Bookshop with Hugo, the primary dependency is the `bookshop/hugo` module. This provides the bookshop partials needed to render components on your website. This import should be placed in your **site** config.toml.

.*site/config.toml*
```toml
[[module.imports]]
path = 'github.com/cloudcannon/bookshop/hugo/v2'
```

To pull in a specific version, use `go get`. i.e. `go get github.com/cloudcannon/bookshop/hugo/v2@2.4.0`.

NOTE: To use a module in Hugo, your site must first be a module itself. After running `hugo mod init github.com/<username>/<repo>` in your site, running Hugo should download the bookshop dependency.

NOTE: Since Hugo Bookshop utilizes the Hugo module system, the link:https://go.dev/doc/install[Go Programming Language] needs to be installed.

The best workflow is then to create a new Hugo module to house your components. This can then be used across multiple websites using the Hugo module system.

.*bash*
```bash
hugo mod init github.com/example/components
```

The file structure within this components module is described in the link:conventions.adoc[Conventions Guide]

The last piece of config is adding the following mounts to the `config.toml` in your **components** module.

.*components/config.toml*
```toml
[[module.mounts]]
source = "."
target = "layouts/partials/bookshop"

[[module.mounts]]
source = "."
target = "assets/bookshop"
```

These mounts allow the `bookshop/hugo` module to locate your components.

See the link:https://github.com/CloudCannon/hugo-bookshop-starter[Hugo Bookshop Starter] for an example of how all of the above looks in practice.

== Writing components

Let's look at an example `button.hugo.html` file.
```
components/
└─ button/
   └─ button.hugo.html
```
These files are namespaced for the static site generator when the filetype is ambiguous, which is why the file is `button.hugo.html` and not `button.html`. Beyond the naming convention, these files are what you would expect when working with Hugo. Our `button.hugo.html` file might look like:
```go
<a class="c-button" href="{{ .link_url }}">{{ .text }}</a>
```
This looks like a normal Hugo include because... it is. While Bookshop provides developer tooling, the job of the `bookshop/hugo` module is to tell Hugo where to find component files. Loading and parsing these files goes through the normal Hugo partial flow.

TIP: The `@bookshop/init` package helps create component structures for you. Running `npx @bookshop/init --component button` would create the button structure needed for Hugo.

== Using components

To use components directly in a template, use the `bookshop` partial.

.*index.html*
```html
...
<div class="hero">
  {{ partial "bookshop" (slice "hero" (dict "title" .Params.title "image" .Params.image)) }}
  {{ partial "bookshop" (slice "button" (dict "label" .Params.cta_text "link_url" .Params.cta_url)) }}
</div>
...
```

This tag expects a slice where the first element is the Bookshop key of a component, and the second element is the value to pass to the component.

If your component is coming from front-matter and has a `_bookshop_name` field, you can pass that object directly to the `bookshop` partial:

.*index.html*
```html
---
components:
  - _bookshop_name: hero
    title: "Hello World"
    image: /image.png
  - _bookshop_name: button
    cta_text: "Get Started"
    link_url: /
---
<div class="hero">
  {{ range .Params.components }}
    {{ partial "bookshop" . }}
  {{ end }}
</div>
```

TIP: _The structures generated by Bookshop for CloudCannon include the `_bookshop_name` field for you. If you're not using structures you will need to add the `_bookshop_name` key by hand_

== Using Bookshop Partials

Bookshop partials can be placed in the `shared/hugo` directory. i.e:
```text
component-library/
├─ components/
└─ shared/
  └─ hugo/
    └─ helper.hugo.html
```

This can then be included using the `bookshop_partial` partial:
```html
  {{ partial "bookshop_partial" (slice "helper" (dict "lorem" "ipsum")) }}
```

The arguments are the same as the `bookshop` partial. This is otherwise a standard Hugo partial, with the extra feature that it can be used anywhere within your Hugo site _or_ your components.

== Importing styles

To import Bookshop styles in Hugo, the plugin provides a `bookshop_scss` partial, which returns a slice of all SCSS resources in your bookshop. This can then be used as such:

.*baseof.html*
```html
{{ $bookshop_scss_files := partial "bookshop_scss" . }}
{{ $scss := $bookshop_scss_files | resources.Concat "css/bookshop.css" | resources.ToCSS | resources.Minify | resources.Fingerprint }}
<link rel="stylesheet" href="{{ $scss.Permalink }}">
```

== Live Editing and Component Browsing with Hugo

Live editing on CloudCannon works mostly out of the box with Bookshop and Hugo. The one piece of information needed is the entry point from a site layout into a component.

This takes the form of the `bookshop_bindings` partial:
```html
  {{ partial "bookshop_bindings" `(dict title .Params.title)` }}
  {{ partial "bookshop" (slice "hero" (dict title .Params.title)) }}


  {{ partial "bookshop_bindings" `.Params.content_blocks` }}
  {{ partial "bookshop_partial" (slice "page" .Params.content_blocks) }}
```

The `bookshop_bindings` partial should be given a string representation of the data passed to the bookshop tag. This allows Bookshop to connect that component with the correct front-matter values when visual editing. This tag is only needed in your site layouts — a Bookshop component using another Bookshop component does not need explicit `bookshop_bindings`.

---

If your layout is rendering a loop of components, that loop will need to exist within a Bookshop component or partial so that new components can be rendered when visual editing. This tends to take the form of a `page.hugo.html` partial in the `shared/hugo` folder of your Bookshop module:

.*bookshop/shared/hugo/page.hugo.html*
```html
{{ range . }}
  {{ partial "bookshop" . }}
{{ end }}
```

Used in your layout:

.*baseof.html*
```html
{{ partial "bookshop_bindings" `.Params.content_blocks` }}
{{ partial "bookshop_partial" (slice "page" .Params.content_blocks) }}
```

=== Configuring Live Editing and Structures

Live Editing with Hugo will require the following npm packages to be installed:
```bash
npm i @bookshop/browser @bookshop/generate @bookshop/hugo-engine
```

These should be in the `package.json` folder at the root of your repository. 

The CloudCannon integration is enabled by the `@bookshop/generate` package. After building your site on CloudCannon, `npx @bookshop/generate` will configure the site for live editing. The recommended script to add is:

.*.cloudcannon/postbuild*
```html
# Clean the npm .bin for CI
rm -rf node_modules
rm -f package-lock.json

# Install and run generate
npm i
npx "@bookshop/generate"
```

This will add your component structures to the CMS, and configure live editing on all pages that contain Bookshop components.

=== Configuring the Component Browser

The packages installed above will also enable the component browser. To install the component browser on a page of your site, use the `bookshop_component_browser` partial in that page's layout.

.*components.html*
```html
{{ partial "bookshop_component_browser" }}
```

If you're running Hugo locally with `hugo server`, open another terminal and run `npx "@bookshop/browser"` in your Bookshop, or a parent directory. You should now be able to visit the page that you installed the component browser on, and see your components in a playground environment.

The same partial enables a hosted version of the component browser with no extra steps. The `@bookshop/generate` command in the `postbuild` above will connect a hosted component library to this tag if it is found in your site.

=== Hugo Live Editing Support

Bookshop's Hugo live editing is built on top of the core Go text/template package. As such, not all Hugo features are supported within Bookshop components. Generally, functions that interact with Hugo or the site as a whole are unavailable. The following tables describe the features and functions currently supported in live-edited Bookshop components.

NOTE: Work is underway to expand support for many of the functions below. Open a GitHub issue if there is a specific function you need for your workflow. 

[cols="1,1"]
|===
|Hugo Feature |Supported in Bookshop 

|link:https://gohugo.io/templates/partials/#returning-a-value-from-a-partial[Partial return values]
|❌

|link:https://gohugo.io/functions/scratch/[.Scratch and newScratch]
|❌
|===

[cols="1,1"]
|===
|Template Function |Supported in Bookshop 

|templates.*
|❌
|os.*
|❌
|urls.*
|❌
|lang / i18n
|❌
|site
|❌
|hugo
|❌
|apply
|❌
|anchorize
|❌
|absURL / absLangURL
|❌
|humanize
|❌
|now
|❌
|Image Filters
|❌
|partialCached
|❌
|getenv
|❌
|fileExists / readDir / readFile
|❌
|ref / relref
|❌
|relURL / relLangURL
|❌
|highlight
|ℹ️ Will pass through the input string unchanged (i.e. it won't work, but it won't error)
|markdownify
|ℹ️ Uses a different markdown implementation. Output isn't guaranteed to match Hugo 1:1
|strings.*
|✅
|reflect.*
|✅
|plainify
|✅
|emojify
|✅
|htmlEscape/htmlUnescape
|✅
|merge
|✅
|symdiff
|✅
|complement
|✅
|append
|✅
|group
|✅
|hmac
|✅
|transform.Unmarshal
|✅
|errorf and warnf
|✅
|float
|✅
|cond
|✅
|ge/gt/le/lt/ne
|✅
|after
|✅
|base64
|✅
|chomp
|✅
|countrunes
|✅
|countwords
|✅
|default
|✅
|delimit
|✅
|dict
|✅
|echoParam
|✅
|eq
|✅
|findRE
|✅
|first
|✅
|hasPrefix
|✅
|in
|✅
|index
|✅
|int
|✅
|intersect
|✅
|isset
|✅
|jsonify
|✅
|last
|✅
|len
|✅
|lower
|✅
|Math
|✅
|md5
|✅
|path.*
|✅
|pluralize
|✅
|print
|✅
|printf
|✅
|println
|✅
|querify
|✅
|range
|✅
|replace
|✅
|replaceRE
|✅

|===

[cols="1,1"]
|===
|Page Function |Supported in Bookshop 

|.AddDate
|❌
|.Format
|❌
|.Get
|❌
|.GetPage
|❌
|.HasMenuCurrent
|❌
|.IsMenuCurrent
|❌
|.Param
|❌
|.Render
|❌
|.RenderString
|❌
|.Scratch
|❌
|.Unix
|❌

|===
