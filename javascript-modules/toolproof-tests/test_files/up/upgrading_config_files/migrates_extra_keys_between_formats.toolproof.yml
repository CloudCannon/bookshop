name: Migrates extra keys between formats

steps:
  - ref: ./background.toolproof.yml
  - step: I have a "component-lib/components/test/test.bookshop.toml" file with the content {toml}
    toml: |-
      something_else = false

      # Metadata about this component, to be used in the CMS
      [spec]
      structures = ['content_blocks']
      label = 'Hero'
      description = 'Main page hero block'
      icon = 'title'
      tags = ['Hero', 'WYSIWYG']

      # Defines the structure of this component, as well as the default values
      [blueprint]
      text = 'Hello World'

      # Overrides any fields in the blueprint when viewing this component in the component browser
      [preview]

      # Any extra CloudCannon inputs configuration to apply to the blueprint
      [_inputs]

      [_select_data]
      superfluous = [ 'a', 'b' ]
  - step: I run "npm start -- --yes --version 3.0.0 --format yml --skip-commands"
  - step: stderr should be empty
  - step: stdout should contain "ðŸŒŸ component-lib/components/test/test.bookshop.toml @ 3.0 â†’ yml @ 3.0"
  - snapshot: The file "component-lib/components/test/test.bookshop.yml"
    snapshot_content: |-
      â•Ž# Metadata about this component, to be used in the CMS
      â•Žspec:
      â•Ž  structures:
      â•Ž    - content_blocks
      â•Ž  label: Hero
      â•Ž  description: Main page hero block
      â•Ž  icon: title
      â•Ž  tags:
      â•Ž    - Hero
      â•Ž    - WYSIWYG
      â•Ž
      â•Ž# Defines the structure of this component, as well as the default values
      â•Žblueprint:
      â•Ž  text: Hello World
      â•Ž
      â•Ž# Overrides any fields in the blueprint when viewing this component in the component browser
      â•Žpreview: {}
      â•Ž
      â•Ž# Any extra CloudCannon inputs configuration to apply to the blueprint
      â•Ž_inputs: {}
      â•Ž
      â•Žsomething_else: false
      â•Ž
      â•Ž_select_data:
      â•Ž  superfluous:
      â•Ž    - a
      â•Ž    - b
  - step: I run "npm start -- --yes --version 3.0.0 --format js --skip-commands"
  - step: stderr should be empty
  - step: stdout should contain "ðŸŒŸ component-lib/components/test/test.bookshop.yml @ 3.0 â†’ js @ 3.0"
  - snapshot: The file "component-lib/components/test/test.bookshop.js"
    snapshot_content: |-
      â•Žmodule.exports = () => {
      â•Ž  // Metadata about this component, to be used in the CMS
      â•Ž  const spec = {
      â•Ž    structures: [ 'content_blocks' ],
      â•Ž    label: 'Hero',
      â•Ž    description: 'Main page hero block',
      â•Ž    icon: 'title',
      â•Ž    tags: [ 'Hero', 'WYSIWYG' ]
      â•Ž  };
      â•Ž
      â•Ž  // Defines the structure of this component, as well as the default values
      â•Ž  const blueprint = { text: 'Hello World' };
      â•Ž
      â•Ž  // Overrides any fields in the blueprint when viewing this component in the component browser
      â•Ž  const preview = {};
      â•Ž
      â•Ž  // Any extra CloudCannon inputs configuration to apply to the blueprint
      â•Ž  const _inputs = {};
      â•Ž
      â•Ž  const extra_fields = {
      â•Ž    something_else: false,
      â•Ž    _select_data: {
      â•Ž      superfluous: [
      â•Ž        'a',
      â•Ž        'b'
      â•Ž      ]
      â•Ž    }
      â•Ž  };
      â•Ž
      â•Ž  return {
      â•Ž    spec,
      â•Ž    blueprint,
      â•Ž    preview,
      â•Ž    _inputs,
      â•Ž    ...extra_fields,
      â•Ž  }
      â•Ž}
  - step: I run "npm start -- --yes --version 3.0.0 --format json --skip-commands"
  - step: stderr should be empty
  - step: stdout should contain "ðŸŒŸ component-lib/components/test/test.bookshop.js @ 3.0 â†’ json @ 3.0"
  - snapshot: The file "component-lib/components/test/test.bookshop.json"
    snapshot_content: |-
      â•Ž{
      â•Ž  "spec": {
      â•Ž    "structures": [
      â•Ž      "content_blocks"
      â•Ž    ],
      â•Ž    "label": "Hero",
      â•Ž    "description": "Main page hero block",
      â•Ž    "icon": "title",
      â•Ž    "tags": [
      â•Ž      "Hero",
      â•Ž      "WYSIWYG"
      â•Ž    ]
      â•Ž  },
      â•Ž  "blueprint": {
      â•Ž    "text": "Hello World"
      â•Ž  },
      â•Ž  "preview": {},
      â•Ž  "_inputs": {},
      â•Ž  "something_else": false,
      â•Ž  "_select_data": {
      â•Ž    "superfluous": [
      â•Ž      "a",
      â•Ž      "b"
      â•Ž    ]
      â•Ž  }
      â•Ž}
